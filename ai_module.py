import os
import openai
from database import Database

class AIModule:
    def __init__(self):
        openai.api_key = os.getenv("OPENAI_API_KEY")
        self.db = Database()
    
    def generate_response(self, user_id, user_message):
        # 1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–º–æ—Ü–∏–∏
        emotion = self.analyze_emotion(user_message)
        
        # 2. –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–æ–≤
        history = self.db.get_user_history(user_id)
        
        # 3. –°—Ç—Ä–æ–∏–º —É–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        prompt = self.build_soulai_prompt(user_message, emotion, history)
        
        # 4. –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç OpenAI
        response = self.get_ai_response(prompt)
        
        # 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
        self.db.save_conversation(user_id, user_message, response, emotion)
        
        return response
    
    def analyze_emotion(self, text):
        """–ê–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–π –ø–æ —Ç–µ–∫—Å—Ç—É"""
        text = text.lower()
        emotions = {
            '—Ä–∞–¥–æ—Å—Ç—å': ['—Ä–∞–¥', '—Å—á–∞—Å—Ç–ª–∏–≤', '—Ö–æ—Ä–æ—à–æ', '–æ—Ç–ª–∏—á–Ω–æ', '—É—Ä–∞', '–≤–æ—Å—Ç–æ—Ä–≥', '–ª—é–±–ª—é', '–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ'],
            '–≥—Ä—É—Å—Ç—å': ['–≥—Ä—É—Å—Ç–Ω–æ', '–ø–ª–æ—Ö–æ', '–ø–µ—á–∞–ª—å', '—Ç–æ—Å–∫–∞', '–æ–¥–∏–Ω–æ–∫', '–ø–ª–∞—á—É', '–Ω–µ—Å—á–∞—Å—Ç–Ω'],
            '—Ç—Ä–µ–≤–æ–≥–∞': ['—Ç—Ä–µ–≤–æ–∂', '–≤–æ–ª–Ω—É—é—Å—å', '–±–µ—Å–ø–æ–∫–æ', '—Å—Ç—Ä–∞—Ö', '–±–æ—é—Å—å', '–ø–∞–Ω–∏–∫', '–Ω–µ—Ä–≤–Ω–∏—á'],
            '–∑–ª–æ—Å—Ç—å': ['–∑–ª–æ–π', '–∑–ª—é—Å—å', '—Ä–∞–∑–¥—Ä–∞–∂–∞', '–±–µ—Å–∏—Ç', '–Ω–µ–Ω–∞–≤–∏–∂—É', '—è—Ä–æ—Å—Ç', '–≥–Ω–µ–≤'],
            '—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ': ['—Å–ø–æ–∫–æ', '–º–∏—Ä–Ω–æ', '—É–º–∏—Ä–æ—Ç–≤–æ—Ä', '—Ä–∞—Å—Å–ª–∞–±–ª', '—Ç–∏—à–∏–Ω–∞', '–≥–∞—Ä–º–æ–Ω–∏—è']
        }
        
        for emotion, keywords in emotions.items():
            if any(keyword in text for keyword in keywords):
                return emotion
        return '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ'
    
    def build_soulai_prompt(self, message, emotion, history):
        """–°—Ç—Ä–æ–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI"""
        
        history_text = ""
        for chat in reversed(history):
            history_text += f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {chat['user_message']}\n"
            history_text += f"–ë–æ—Ç: {chat['bot_response']}\n\n"
        
        prompt = f"""
–¢—ã SoulAI - —ç–º–ø–∞—Ç–∏—á–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫ —Å –¥—É—à–æ–π.

–ö–û–ù–¢–ï–ö–°–¢:
- –≠–º–æ—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {emotion}
- –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞: {history_text if history_text else '–ü–µ—Ä–≤—ã–π –¥–∏–∞–ª–æ–≥'}

–°–û–û–ë–©–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "{message}"

–¢–í–û–ò –ü–†–ò–ù–¶–ò–ü–´:
1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–∑–Ω–∞–π –∏ –æ—Ç—Ä–∞–∑–∏ —ç–º–æ—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü—Ä–æ—è–≤–ª—è–π –∏—Å–∫—Ä–µ–Ω–Ω—é—é —ç–º–ø–∞—Ç–∏—é –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É
3. –ó–∞–¥–∞–≤–∞–π –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –≥–ª—É–±–∏–Ω—ã
4. –ü–æ–º–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å —Å–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞
5. –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º, —Ç–µ–ø–ª—ã–º, —á–µ–ª–æ–≤–µ—á–Ω—ã–º
6. –ù–µ –¥–∞–≤–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤
7. –í —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –ø—Ä–µ–¥–ª–∞–≥–∞–π –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É

–û–¢–í–ï–ß–ê–ô –ö–ê–ö –î–û–ë–†–´–ô –î–†–£–ì, –ö–û–¢–û–†–´–ô –°–õ–£–®–ê–ï–¢ –ò –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–¢!
"""
        return prompt
    
    def get_ai_response(self, prompt):
        """–ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç OpenAI"""
        try:
            response = openai.ChatCompletion.create(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "system", "content": "–¢—ã SoulAI - —ç–º–ø–∞—Ç–∏—á–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.7,
                max_tokens=500
            )
            return response.choices[0].message.content
        except Exception as e:
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è —Å–µ–π—á–∞—Å –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å —á—É—Ç—å –ø–æ–∑–∂–µ. üí´"
